#!/usr/bin/env bash
#
# Fatpub-SVG-Convert â€“ Converts all X.svg in INDIR into the specified output format. (X.svg -> X.svg.png)
# Copyright (C) 2022 Henning Schwentner
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
#
# Usage: convert-svg-files 'input directory' 'output directory' 'output_format' 'dpi for PNG conversion'
# Example: convert-svg-files manuscript/images tmp/images eps 1200


# Ignore empty directories
shopt -s nullglob

# Use headless X server and no paralellization on Linux
if [[ "$OSTYPE" == "darwin"* ]]; then
    DRAWIO='drawio'
    FOREGROUND=''
else
    DRAWIO='xvfb-run -a drawio'
    set -m
    FOREGROUND='fg'

# In a Docker container we need something like this:
#    DRAWIO="${DRAWIO} --no-sandbox"
#    mkdir -p /var/run/dbus
#    dbus-daemon --config-file=/usr/share/dbus-1/system.conf --print-address
fi


if test $# != 4
then
    echo "Please specify exactly four parameters with input directory, output directory, an output format like: png or eps, and a dpi number like 300."
    exit 1
fi

INDIR=${1}
OUTDIR=${2}
OUTPUTFORMAT=${3}
DPI=${4}

mkdir -p ${OUTDIR}
OUTDIR=`realpath ${OUTDIR}`

pushd ${INDIR}

for subdir in */; do
    echo "Entering ${subdir}"
    mkdir -p ${OUTDIR}/${subdir}
    
    for svgfile in ${subdir}*.svg; do
        if [[ ${svgfile} == *.drawio.svg ]]; then
            #echo "Converting ${svgfile} with Draw.io"
            if [ ${OUTPUTFORMAT} == png ]; then
                ${DRAWIO} --export --scale 10 --output ${OUTDIR}/${svgfile}.png ${svgfile} \
                && echo "Converted ${svgfile} with Draw.io" \
                & ${FOREGROUND}
            elif  [ ${OUTPUTFORMAT} == eps ]; then
                ${DRAWIO} --export --crop --output ${OUTDIR}/${svgfile}.pdf ${svgfile} \
                && pdftops -eps -r ${DPI} ${OUTDIR}/${svgfile}.pdf \
                && rm ${OUTDIR}/${svgfile}.pdf \
                && echo "Converted ${svgfile} with Draw.io" \
                & ${FOREGROUND}
            else
                exit 2
            fi
        else
            #echo "Converting ${svgfile} with Inkscape"
            inkscape \
                --export-dpi=${DPI} \
                --export-filename=${OUTDIR}/${svgfile}.${OUTPUTFORMAT} \
                ${svgfile} \
            && echo "Converted ${svgfile} with Inkscape" \
            & ${FOREGROUND}
        fi
    done
done
wait

popd
