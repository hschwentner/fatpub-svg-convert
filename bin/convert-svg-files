#!/usr/bin/env bash
# Converts all X.svg in INDIR into the specified output format. (-> X.svg.png in tmp )
# Usage: convert-svg-files 'output_format'
# Example: convert-svg-files eps


# Ignore empty directories
shopt -s nullglob

# Use headless X server and no paralellization on Linux
if [[ "$OSTYPE" == "darwin"* ]]; then
    DRAWIO='drawio'
    FOREGROUND=''
else
    DRAWIO='xvfb-run -a drawio'
    set -m
    FOREGROUND='fg'
fi


if test $# != 4
then
    echo "Please specify exactly four parameters with input directory, output directory, an output format like: png or eps, and a dpi number like 300."
    exit 1
fi

INDIR=${1}
OUTDIR=${2}
OUTPUTFORMAT=${3}
DPI=${4}

mkdir -p ${OUTDIR}
OUTDIR=`realpath ${OUTDIR}`

pushd ${INDIR}

for subdir in */; do
    echo "Entering ${subdir}"
    mkdir -p ${OUTDIR}/${subdir}
    
    for svgfile in ${subdir}*.svg; do
        if [[ ${svgfile} == *.drawio.svg ]]; then
            #echo "Converting ${svgfile} with Draw.io"
            if [ ${OUTPUTFORMAT} == png ]; then
                ${DRAWIO} --export --scale 10 --output ${OUTDIR}/${svgfile}.png ${svgfile} \
                && echo "Converted ${svgfile} with Draw.io" \
                & ${FOREGROUND}
            elif  [ ${OUTPUTFORMAT} == eps ]; then
                ${DRAWIO} --export --crop --output ${OUTDIR}/${svgfile}.pdf ${svgfile} \
                && pdftops -eps -r ${DPI} ${OUTDIR}/${svgfile}.pdf \
                & ${FOREGROUND}
            else
                exit 2
            fi
        else
            #echo "Converting ${svgfile} with Inkscape"
            inkscape \
                --export-dpi=${DPI} \
                --export-filename=${OUTDIR}/${svgfile}.${OUTPUTFORMAT} \
                ${svgfile} \
            && echo "Converted ${svgfile} with Inkscape" \
            & ${FOREGROUND}
        fi
    done
done
wait

popd
